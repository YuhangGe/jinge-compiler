/**
 * mvvm framework for https://jinge.design
 * @version: 2.0.0
 * @copyright: 2020 Yuhang Ge <abeyuhang@gmail.com>
 * @license: MIT
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).jinge={})}(this,(function(t){"use strict";function e(t){return typeof t}function n(t){return null!==t&&"object"===e(t)}function r(t){return"string"===e(t)}function s(t){return"number"===e(t)&&!Number.isNaN(t)&&Number.isFinite(t)}function o(t){return"undefined"===e(t)}function i(t){return Array.isArray(t)}function a(t){return"function"===e(t)}function l(t){return n(t)&&a(t.then)}function c(t,e){const n=t.indexOf(e);return!(n<0)&&(t.splice(n,1),!0)}function h(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}let _=0;function d(){return Date.now().toString(32)+"-"+Math.floor(16777215*Math.random()).toString(32)+"-"+(_++).toString(32)}let u,f,p=0,m=1,E=!1;function g(t){u.delete(t)}function y(t){if(E)return void setTimeout(y,0,t);const e=u.get(t);if(e){E=!0;try{e()}finally{g(t),E=!1}}}if(o(window.setImmediate)){u=new Map;const t="setImmediate$"+(p++).toString(32)+"$";window.addEventListener("message",e=>{e.source===window&&r(e.data)&&e.data.startsWith(t)&&y(Number(e.data.slice(t.length)))},!1),f=function(e){window.postMessage(t+e,"*")}}const N=window.setImmediate||function(t){if(!a(t)||arguments.length>1)throw new Error("setImmediate require callback function.");return u.set(m,t),f(m),m++},w=window.clearImmediate||g;function x(t=""){return document.createTextNode(r(t)?t:JSON.stringify(t))}function v(t){const e=document.createDocumentFragment();return t&&t.forEach(t=>{e.appendChild(r(t)?document.createTextNode(t):t)}),e}function D(t,e){t.appendChild(v(e))}function C(t,e,n){t.replaceChild(v(e),n)}function S(t,e){if(e){if(!n(e))return t.removeAttribute(e);for(const n in e)S(t,n)}}function b(t,e,r){if(e)if(n(e))for(const n in e)b(t,n,e[n]);else o(r)||null===r?S(t,e):t.setAttribute(e,r)}function T(t,e,n){if(e)for(const n in e)n&&!o(e[n])&&b(t,n,e[n]);return D(t,n),t}function R(t,e,...n){return T(document.createElement(t),e,n)}function O(t,e,...n){return T(document.createElementNS("http://www.w3.org/2000/svg",t),e,n)}function M(t,e,n){const r=n.nextSibling;r?t.insertBefore(e,r):t.appendChild(e)}function I(t,e,n,r){o(r)&&(r=!!e.startsWith("touch")&&{capture:!1,passive:!0}),t.addEventListener(e,n,r)}function L(t,e,n){t.removeEventListener(e,n)}function A(t,e,n,r){return I(t,e,n,r),function(){L(t,e,n)}}const V=Symbol("$$");function P(t){const e=t.constructor;return e===RegExp||e===Date||e===Boolean}function k(t){return n(t)&&V in t}function U(t){return r(t)&&95!==t.charCodeAt(0)}function j(t){return r(t)?t:null===t?"null":o(t)?"undefined":t.toString()}function H(t){return r(t)?t.indexOf(".")>0?t.split("."):[t]:i(t)?t:[t]}function $(t,e,n){t.__parents||(t.__parents=[]),t.__parents.push({core:e,prop:n})}function F(t,e,n){if(!t.__parents)return;const r=t.__parents.findIndex(t=>t.core===e&&t.prop===n);r>=0&&t.__parents.splice(r,1)}function G(t,e,n,r){if(!t.__parents)return;const s=t.__parents.find(t=>t.core===e&&t.prop===n);s&&(s.prop+=r)}const B=new Map;function W(t){const e=B.get(t);e&&(w(e.immediate),B.delete(t))}function Z(t,e){if(B.has(t))return;const n=N(()=>{const e=B.get(t);try{t(e.propertyPath)}finally{B.delete(t)}});B.set(t,{immediate:n,propertyPath:e})}function q(t,e,n){const r=e.__handlers;r&&r.forEach(e=>{n?e(t):Z(e,t)});const s=e.__listeners;s&&s.forEach(e=>{q(t,e,n)})}function Y(t,e,n,r=0){const s=t.__listeners;if(!s)return;const o=j(e[r]);if(!o)return;let i=s.get(o);i&&(e.length-1===r?q(e,i,n):Y(i,e,n,r+1)),i=s.get("*"),i&&(e.length-1===r?q(e,i,!0):Y(i,e,n,r+1)),i=s.get("**"),i&&q(e,i,!0)}function z(t,e,n=0){const r=j(e[n]);t.__listeners||(t.__listeners=new Map);let s=t.__listeners.get(r);return s||(s={__parent:t,__property:r,__handlers:null,__listeners:null},t.__listeners.set(r,s)),e.length-1===n?s:z(s,e,n+1)}function J(t,e,n=0){var r;const s=j(e[n]);if(!s)return null;const o=null===(r=t.__listeners)||void 0===r?void 0:r.get(s);return o?e.length-1===n?o:J(o,e,n+1):null}function K(t){if(t&&t.__handlers&&t.__handlers.length>0||t.__listeners&&t.__listeners.size>0)return null;const e=t.__parent,n=t.__property;return t.__parent=null,e.__listeners.delete(n),e}function Q(t){const e=t.__listeners;e&&(e.forEach(t=>Q(t)),t.__listeners=null);const n=t.__handlers;n&&(n.forEach(W),t.__handlers=null),t.__parent=null}class X{constructor(t){this.__notifiable=!0,this.__parents=null,this.__listeners=null,this.__related=null,this.__setters=null,this.target=t,this.proxy=null,Object.defineProperty(t,V,{value:this,writable:!1,configurable:!0,enumerable:!1})}__watch(t,e,n){const r=(t=H(t)).indexOf("**");if(r>=0&&r!==t.length-1)throw new Error('wizard "**" must be last element in path.');const s=z(this,t);s.__handlers||(s.__handlers=[]),s.__handlers.indexOf(e)<0&&s.__handlers.push(e),n&&n!==this&&n.__addRelated(this,t,e)}__unwatch(t,e,n){if(!t)return void Q(this);const r=J(this,H(t));if(!r)return;const s=r.__handlers;s&&(e?(W(e),c(s,e)):(s.forEach(W),s.length=0),K(r),n&&n!==this&&n.__rmRelated(this,t,e))}__notify(t,e=!1){if(!this.__notifiable)return;t=H(t),this.__listeners&&Y(this,t,e);const n=this.__parents;n&&n.forEach(n=>{const r=n.core;r?r.__notify([n.prop].concat(t),e):console.error("dev-warn-unexpected: parent of ViewModelCore has been destroied but not unlink.")})}__destroy(){this.__notifiable=!1,this.__parents=null,Q(this),this.proxy=null,this.__related&&(this.__related.forEach((t,e)=>{t.forEach(t=>{e.__unwatch(t.prop,t.handler)})}),this.__related=null);const t=this.target,e=this.__setters;e&&(e.forEach((e,r)=>{if(null===e)return;const s=t[r];n(s)&&V in s&&F(s[V],this,r)}),this.__setters=null),Object.getOwnPropertyNames(t).forEach(e=>{const r=t[e];n(r)&&V in r&&F(r[V],this,e)}),delete t[V],this.target=null}__addRelated(t,e,n){this.__related||(this.__related=new Map);let r=this.__related.get(t);r||this.__related.set(t,r=[]),r.push({prop:e,handler:n})}__rmRelated(t,e,n){if(!this.__related)return;const r=this.__related.get(t);if(!r)return;const s=i(e),o=r.findIndex(t=>n===t.handler&&(s?h(e,t.prop):e===t.prop));o>=0&&r.splice(o,1)}}function tt(t,e){t[V].__notify(e)}function et(t,e,r,s,i=!0){if(!U(e))return t[e]=r,!0;const a=t[e];if(a===r&&!o(r))return!0;let l=n(r)&&!P(r);if(l&&(l=V in r,i&&!l))throw new Error(`public property "${e.toString()}" of ViewModel must also be ViewModel`);return n(a)&&V in a&&F(a[V],t[V],e),s(t,e,r),l&&$(r[V],t[V],e),tt(t,e),!0}function nt(t,e,n){t[e]=n}function rt(t,e,n){const r=function(t,e){let n=t[V].__setters;if(n||(t[V].__setters=n=new Map),n.has(e))return n.get(e);{let r,s=t.constructor,o=Object.getOwnPropertyDescriptor(s.prototype,e);if(o)return r=a(o.set)?o.set:null,n.set(e,r),r;for(s=Object.getPrototypeOf(s);s&&s.prototype;){if(o=Object.getOwnPropertyDescriptor(s.prototype,e),o)return r=a(o.set)?o.set:null,n.set(e,r),r;s=Object.getPrototypeOf(s)}return n.set(e,null),null}}(t,e);r?r.call(t[V].proxy,n):t[e]=n}function st(t,e,n){return!(V in t)||et(t,e,n,nt)}function ot(t,e,n){return!(V in t)||et(t,e,n,nt,!1)}function it(t,e,n){return V in t?et(t,e,n,rt):(console.warn(`call setter "${e.toString()}" after destroied, resources such as setInterval maybe not released before destroy. component:`,t),!0)}function at(t,e,n){let r=e;for(e>n&&(r=n,n=e);r<n;r++)tt(t,r)}const lt={set:st},ct={get(t,e){if("then"===e||"catch"===e){const n=t[e];return function(...e){return n.call(t,...e)}}return t[e]},set:st};function ht(t,e,n){return t.forEach((e,n)=>{k(e)&&$(e[V],t[V],n)}),t[e](n),t.forEach((e,n)=>{k(e)&&F(e[V],t[V],n)}),at(t,0,t.length),t[V].proxy}function _t(t,e=!1){const n=mt(t,!0);return t.forEach((n,r)=>{k(n)?$(n[V],t[V],r):e&&(t[r]=gt(n))}),n}function dt(t,e){t.forEach((n,r)=>{k(n)&&G(n[V],t[V],r,e)})}function ut(t,e){if(n(t)){if(V in t)return!0;throw new Error(`argument passed to Array.${e} must be ViewModel if the array is ViewModel`)}return!1}const ft={splice(t,e,n,...r){e<0&&(e=0),r.forEach((n,r)=>{ut(n,"splice")&&$(n[V],t[V],e+r)});for(let r=0;r<n&&!(e+r>=t.length);r++){const n=t[e+r];k(n)&&F(n[V],t[V],e+r)}const s=r.length-n;if(0!==s)for(let r=e+n;r<t.length;r++){const e=t[r];k(e)&&G(e[V],t[V],r,s)}const o=_t(t.splice(e,n,...r));if(0!==s){tt(t,"length");for(let n=e;n<t.length;n++)tt(t,n)}return o},shift(t){if(0===t.length)return t.shift();dt(t,-1);const e=t.shift();k(e)&&F(e[V],t[V],-1),tt(t,"length");for(let e=0;e<t.length+1;e++)tt(t,e);return e},unshift(t,...e){if(0===e.length)return t.unshift();e.forEach((e,n)=>{ut(e,"unshift")&&$(e[V],t[V],n)}),dt(t,e.length);const n=t.unshift(...e);tt(t,"length");for(let e=0;e<t.length;e++)tt(t,e);return n},pop(t){if(0===t.length)return t.pop();const e=t.pop();return k(e)&&F(e[V],t[V],t.length),tt(t,"length"),tt(t,t.length),e},push(t,...e){if(0===e.length)return t.push();e.forEach((e,n)=>{ut(e,"push")&&$(e[V],t[V],t.length+n)});const n=t.push(...e);tt(t,"length");for(let n=t.length-1-e.length;n<t.length;n++)tt(t,n);return n},fill:(t,e)=>(ut(e,"fill"),t.forEach((n,r)=>{(n!==e||o(n))&&(k(n)&&F(n[V],t[V],r),t[r]=e,k(e)&&$(e[V],t[V],r),tt(t,r))}),t[V].proxy),reverse:t=>ht(t,"reverse"),sort:(t,e)=>ht(t,"sort",e),concat:(t,e)=>(ut(e,"concat"),_t(t.concat(e))),filter:(t,e)=>_t(t.filter(e)),slice:(t,e,n)=>_t(t.slice(e,n)),map:(t,e)=>_t(t.map(e),!0)},pt={get(t,e){if(e in ft){const n=ft[e];return function(...e){return n(t,...e)}}return t[e]},set:function(t,e,n){return!(V in t)||("length"===e?function(t,e){if(!s(e))throw new Error("bad argument. array length must be validate number.");const n=t.length;if(n>e)for(let r=e;r<n;r++){const e=t[r];k(e)&&F(e[V],t[V],r)}return t.length=e,n!==e&&(tt(t,"length"),at(t,n,e)),!0}(t,n):et(t,e,n,nt))}};function mt(t,e){return new X(t).proxy=new Proxy(t,e?pt:l(t)?ct:lt)}function Et(t,e,r){n(e)&&!P(e)&&(V in e||(t[r]=e=gt(e)),$(e[V],t[V],r))}function gt(t){if(n(t)){if(P(t)||V in t)return t;const e=i(t),n=mt(t,e);if(e)for(let e=0;e<t.length;e++)Et(t,t[e],e);else for(const e in t)U(e)&&Et(t,t[e],e);return n}return t}function yt(t){const e=new X(t);return e.__notifiable=!1,e.proxy=new Proxy(t,{set:ot})}function Nt(t){if(V in t)throw new Error("component has alreay been wrapped.");const e=new X(t);return e.__notifiable=!1,e.proxy=new Proxy(t,{set:it})}function wt(t){if(!n(t))throw new Error("vm() target must be object or array.");return gt(t)}function xt(t){if(!n(t)||i(t))throw new Error("attrs() traget must be plain object.");return yt(t)}const vt=Symbol("listeners");class Dt{constructor(t){if(this[vt]=null,t)for(const e in t){const n=t[e];this.__on(e,n.fn,n.opts)}}__notify(t,...e){if(!this[vt])return;const n=this[vt].get(t);n&&n.forEach(t=>{t.fn(...e)})}__on(t,e,n){this[vt]||(this[vt]=new Map);let r=this[vt].get(t);if(r||this[vt].set(t,r=[]),r.findIndex(t=>t.fn===e)>=0)console.warn("dulplicated messenger listener",t,e);else if(n&&n.once){const s=(...n)=>{e(...n),this.__off(t,e)};r.push({fn:s,opts:n})}else r.push({fn:e,opts:n})}__off(t,e){if(!this[vt])return;if(!t)return void this[vt].clear();const n=this[vt].get(t);if(!n)return;if(!e)return void(n.length=0);const r=n.findIndex(t=>t.fn===e);n.splice(r,1)}}const Ct=new class{constructor(){this.m=new Map,this.s=0}create(t){if(0===this.s)return;const e=R("style",{type:"text/css",id:t.dom});document.head.appendChild(e),e.styleSheet?e.styleSheet.cssText=t.css:e.textContent=t.css}add(t){if(!t)return;const e=this.m;let n=e.get(t.id);n?n.refs++:(n={id:t.id,css:t.css,dom:`__${t.id}__`,refs:1},e.set(t.id,n),this.create(n))}attch(){0===this.s?(this.s=1,function(){const t=R("span",{style:"position:absolute;left:-10000px;",class:"jg-hide"});document.body.appendChild(t);const e="none"===getComputedStyle(t).getPropertyValue("display");return document.body.removeChild(t),e}()||this.create({dom:`__jgsty_${d()}__`,css:".jg-hide{display:none!important}.jg-hide.jg-hide-enter,.jg-hide.jg-hide-leave{display:block!important}"}),this.m.forEach(t=>{this.create(t)})):console.warn("component styles already attached.")}remove(t){if(!t)return;const e=this.m.get(t.id);e&&(e.refs--,e.refs>0||(this.m.delete(e.id),0!==this.s&&document.head.removeChild(document.getElementById(e.dom))))}};function St(t){return new Function("__ctx",`return \`${t.replace(/`/g,"\\`").replace(/\$\{\s*([\w\d._$]+)\s*\}/g,(t,e)=>"${ __ctx."+e+" }")}\`;`)}const bt=new class extends Dt{constructor(){super(),this.__deps=null,this.__data=null,this.__cache=new Map,this.__key=null,this.__regLoc(window.JINGE_I18N_DATA)}get locale(){return this.__data.locale}__regDep(t,e){if(this.__deps||(this.__deps=[]),!this.__deps[t])throw new Error("conflict at "+t);this.__deps[t]=e}__regLoc(t){t&&!this.__cache.has(t.locale)&&(this.__cache.set(t.locale,t),this.__data||(this.__data=t))}switch(t,e="dist/locale.[locale].js"){if(this.__data.locale===t)return;const n=this.__cache.get(t);if(n)this.__data=n,this.__notify("i18n-change",this.locale);else{const n=d();this.__key=n,(a(e)?e(t):function(t,e){return window.fetch(e.replace("[locale]",t)).then(t=>t.text())}(t,e)).then(e=>{if(new Function("jinge",e)({i18n:this}),this.__key!==n||this.__data.locale===t)return;const r=this.__cache.get(t);this.__data=r,this.__notify("i18n-change",this.locale)})}}__t(t,e){const n=this.__data.dictionary;if(!(t in n))return"i18n_missing";let s=n[t];return r(s)&&(171===s.charCodeAt(0)?(s=n[s.substring(1)],r(s)&&(s=St(s))):s=St(s),n[t]=s),s(e)}__r(t,e){const n=this.__data.render;if(a(n)){if(!this.__deps)throw new Error("missing render depedents");this.__data.render=n(...this.__deps)}const s=n[e];if(!(t in s))throw new Error(`missing i18n ${e} for key: ${t}`);let o=s[t];return r(o)&&(s[t]=o=s[o]),o}watch(t,e){return this.__on("change",t),e&&t(this.locale),()=>{this.__off("change",t)}}};var Tt,Rt;(Tt=t.ComponentStates||(t.ComponentStates={}))[Tt.INITIALIZE=0]="INITIALIZE",Tt[Tt.RENDERED=1]="RENDERED",Tt[Tt.WILLDESTROY=2]="WILLDESTROY",Tt[Tt.DESTROIED=3]="DESTROIED",(Rt=t.ContextStates||(t.ContextStates={}))[Rt.UNTOUCH=0]="UNTOUCH",Rt[Rt.TOUCHED=1]="TOUCHED",Rt[Rt.UNTOUCH_FREEZED=2]="UNTOUCH_FREEZED",Rt[Rt.TOUCHED_FREEZED=3]="TOUCHED_FREEZED";const Ot=Symbol("__");function Mt(t){return Ot in t}function It(t){if(!i(t)||0===t.length)throw new Error("Render results of component is empty");return t}class Lt extends Dt{constructor(e){if(!n(e)||!(V in e))throw new Error("Attributes passed to Component constructor must be ViewModel. See https://[todo]");const r=e[Ot]||{};super(r.listeners),Nt(this),this[Ot]={passedAttrs:e,context:r.context,contextState:t.ContextStates.UNTOUCH,slots:r.slots,state:t.ComponentStates.INITIALIZE,rootNodes:[],nonRootCompNodes:[],refs:null,relatedRefs:null,updateNextMap:null,compStylePid:null,deregDOM:null,deregI18N:null}}static create(t){return n(t=t||xt({}))&&V in t||(t=xt(t||{})),new this(t)[V].proxy}__i18nWatch(t,e){let n=this[Ot].deregI18N;n||(this[Ot].deregI18N=n=[]);const r=bt.watch(()=>{t.call(this)},e),s=()=>{r(),c(n,s)};return n.push(s),s}__domAddListener(t,e,n,r){let s=this[Ot].deregDOM;s||(this[Ot].deregDOM=s=[]);const o=A(t,e,t=>{n.call(this,t)},r),i=()=>{o(),c(s,i)};return s.push(i),i}__domPassListeners(e,n){if(this[Ot].state!==t.ComponentStates.RENDERED)throw new Error("domPassListeners must be applied to component which is rendered.");const r=this[vt];r&&0!==r.size&&(e&&!i(e)?(n=e,e=null):n||(n=this.__firstDOM),n.nodeType===Node.ELEMENT_NODE&&r.forEach((t,r)=>{e&&e.indexOf(r)>=0||t.forEach(t=>{const{opts:e,fn:s}=t;this.__domAddListener(n,r,t.opts&&(t.opts.stop||t.opts.prevent)?function(t){e.stop&&t.stopPropagation(),e.prevent&&t.preventDefault(),s.call(this,t)}:s,t.opts)})}))}get __transitionDOM(){const t=this[Ot].rootNodes[0];return Mt(t)?t.__transitionDOM:t}get __firstDOM(){const t=this[Ot].rootNodes[0];return Mt(t)?t.__firstDOM:t}get __lastDOM(){const t=this[Ot].rootNodes,e=t[t.length-1];return Mt(e)?e.__lastDOM:e}__render(){const t=this.constructor;let e=t.template;if(!e&&this[Ot].slots&&(e=this[Ot].slots.default),!a(e))throw new Error(`Template of ${t.name} not found. Forget static getter "template"?`);return Ct.add(t.style),e(this)}__renderToDOM(e,n=!0){if(this[Ot].state!==t.ComponentStates.INITIALIZE)throw new Error("component has already been rendered.");const r=It(this.__render());Ct.attch(),n?C(e.parentNode,r,e):D(e,r),this.__handleAfterRender()}__destroy(e=!0){const n=this[Ot];n.state>t.ComponentStates.WILLDESTROY||(n.state=t.ComponentStates.WILLDESTROY,this[V].__notifiable=!1,n.passedAttrs[V].__notifiable=!1,this.__notify("before-destroy"),this.__beforeDestroy(),this.__handleBeforeDestroy(e),super.__off(),Ct.remove(this.constructor.style),n.passedAttrs[V].__destroy(),n.passedAttrs=null,this[V].__destroy(),n.updateNextMap&&(n.updateNextMap.forEach(t=>{w(t)}),n.updateNextMap=null),n.relatedRefs&&(n.relatedRefs.forEach(t=>{const e=t.origin[Ot].refs;if(!e)return;const n=e.get(t.ref);i(n)?c(n,t.node||this):e.delete(t.ref)}),n.relatedRefs=null),n.deregDOM&&(n.deregDOM.forEach(t=>t()),n.deregDOM=null),n.deregI18N&&(n.deregI18N.forEach(t=>t()),n.deregI18N=null),n.state=t.ComponentStates.DESTROIED,n.rootNodes=n.nonRootCompNodes=n.refs=n.slots=n.context=null)}__handleBeforeDestroy(t=!1){let e;this[Ot].nonRootCompNodes.forEach(t=>{t.__destroy(!1)}),this[Ot].rootNodes.forEach(n=>{Mt(n)?n.__destroy(t):t&&(e||(e=n.parentNode),e.removeChild(n))})}__handleAfterRender(){this[Ot].passedAttrs[V].__notifiable=!0,this[V].__notifiable=!0,this[Ot].rootNodes.forEach(t=>{Mt(t)&&t.__handleAfterRender()}),this[Ot].nonRootCompNodes.forEach(t=>{Mt(t)&&t.__handleAfterRender()}),this[Ot].state=t.ComponentStates.RENDERED,this[Ot].contextState=this[Ot].contextState===t.ContextStates.TOUCHED?t.ContextStates.TOUCHED_FREEZED:t.ContextStates.UNTOUCH_FREEZED,this.__afterRender(),this.__notify("after-render")}__updateIfNeed(e,n=!0){if(this[Ot].state!==t.ComponentStates.RENDERED)return;if(!1===e)return this.__update();if(a(e)||(e=this.__update),!n)return void e.call(this);let r=this[Ot].updateNextMap;r||(r=this[Ot].updateNextMap=new Map),r.has(e)||r.set(e,N(()=>{r.delete(e),e.call(this)}))}__update(t){}__setContext(e,n,r=!1){if(this[Ot].contextState===t.ContextStates.UNTOUCH_FREEZED||this[Ot].contextState===t.ContextStates.TOUCHED_FREEZED)throw new Error("Can't setContext after component has been rendered. Try put setContext code into constructor.");if(this[Ot].contextState===t.ContextStates.UNTOUCH&&(this[Ot].context=Object.assign({},this[Ot].context),this[Ot].contextState=t.ContextStates.TOUCHED),e in this[Ot].context&&!r)throw new Error(`Contenxt with key: ${e.toString()} is exist. Pass third argument forceOverride=true to override it.`);this[Ot].context[e]=n}__getContext(t){return this[Ot].context?this[Ot].context[t]:null}__setRef(t,e,n){let r=this[Ot].refs;r||(this[Ot].refs=r=new Map);let s=r.get(t);s?i(s)?s.push(e):(s=[s,e],r.set(t,s)):r.set(t,e);const o=Mt(e);if(!o&&this===n)return;let a=(o?e:n)[Ot].relatedRefs;a||((o?e:n)[Ot].relatedRefs=a=[]),a.push({origin:this,ref:t,node:o?null:e})}__getRef(e){return this[Ot].state!==t.ComponentStates.RENDERED&&console.warn(`Warning: call __getRef before component '${this.constructor.name}' rendered will get nothing. see https://[TODO]`),this[Ot].refs?this[Ot].refs.get(e):null}__addStylePid(t,e){if(!t&&!e)return;let n=this[Ot].compStylePid;n||(n=this[Ot].compStylePid=Object.create(null)),t&&Object.assign(n,t),e&&(n[e]="")}__afterRender(){}__beforeDestroy(){}}var At;function Vt(t){const e=getComputedStyle(t);return"0s"!==e.getPropertyValue("transition-duration")?"transitionend":"0s"!==e.getPropertyValue("animation-duration")?"animationend":null}function Pt(t){return/ms$/.test(t)?parseInt(t):/s$/.test(t)?1e3*parseFloat(t):0}Lt[Ot]=!0,(At=t.TransitionStates||(t.TransitionStates={}))[At.ENTERING=1]="ENTERING",At[At.ENTERED=2]="ENTERED",At[At.LEAVING=3]="LEAVING",At[At.LEAVED=4]="LEAVED";class kt extends Lt{constructor(t){if(!t||!n(t.class))throw new Error('<toggle-class> component require "class" attribute to be Object.');super(t),this.domClass=t.class,this.transition=!!t.transition,this._t=null,this._i=-1,this[V].__watch("domClass.**",()=>{this.__updateIfNeed()})}__render(){const t=super.__render();return this.__update(!0),t}__beforeDestroy(){this._t=null}__update(e){const n=this.transition?this.__transitionDOM:null;if(n&&n.nodeType!==Node.ELEMENT_NODE)return;this.transition&&!this._t&&(this._t=new Map);const r=this.domClass;Object.keys(r).forEach(s=>{const o=r[s];if(!this.transition)return void function t(e,n,r){Mt(e)?e[Ot].rootNodes.forEach(e=>t(e,n,r)):n?e.classList.add(r):e.classList.remove(r)}(this,!!o,s);if(e)return this._t.set(s,[o?t.TransitionStates.ENTERED:t.TransitionStates.LEAVED,null]),void(o?n.classList.add(s):n.classList.remove(s));const i=this._t.get(s);if(!i)return void console.error("Unsupport <toogle-class> attribute. see https://todo");const a=i[0];if(o&&a<=t.TransitionStates.ENTERED||!o&&a>=t.TransitionStates.LEAVING)return;a===(o?t.TransitionStates.LEAVING:t.TransitionStates.ENTERING)&&(n.classList.remove(s+(o?"-leave-active":"-enter-active")),n.classList.remove(s+(o?"-leave":"-enter")),L(n,"transitionend",i[1]),L(n,"animationend",i[1]),i[1]=null,this.__notify("transition",o?"leave-cancelled":"enter-cancelled",s,n));const l=s+(o?"-enter":"-leave"),c=s+(o?"-enter-active":"-leave-active");n.classList.add(l),Vt(n),n.classList.add(c);const h=Vt(n);if(!h)return n.classList.remove(l),n.classList.remove(c),i[0]=o?t.TransitionStates.ENTERED:t.TransitionStates.LEAVED,void(o?n.classList.add(s):n.classList.remove(s));const _=()=>{L(n,"transitionend",_),L(n,"animationend",_),n.classList.remove(l),n.classList.remove(c),i[1]=null,i[0]=o?t.TransitionStates.ENTERED:t.TransitionStates.LEAVED,o?n.classList.add(s):n.classList.remove(s),this.__notify("transition",o?"after-enter":"after-leave",s,n)};i[0]=o?t.TransitionStates.ENTERING:t.TransitionStates.LEAVING,i[1]=_,I(n,h,_),this.__notify("transition",o?"before-enter":"before-leave",s,n),N(()=>{this.__notify("transition",o?"enter":"leave",s,n)})})}}class Ut extends Lt{constructor(t,e,n,r){super(t),k(e)?this.each=e:this._e=e,this.index=n,this.isFirst=0===n,this.isLast=r}get each(){return this._e}set each(t){this._e=t}__render(){return this[Ot].slots.default(this)}}function jt(t,e,n,r,s,o){const i=new Ut(xt({[Ot]:{context:s,slots:{default:r}}}),t,e,n);return o&&i.__addStylePid(o),i[V].proxy}function Ht(t,e,n,r,s,o,i){const a=jt(t,e,n,r,o,i);return s.push(a),a.__render()}function $t(t,e,n,r){const s="each"===r?t:r(t);return n.has(s)&&console.error(`loop items [${e}] and [${n.get(s)}] of <for> component both have key '${s}', dulplicated key may cause update error.`),n.set(s,e),s}function Ft(t,e,n,r,s,o,i){const a=[],l=new Map;return t.forEach((c,h)=>{"index"!==s&&r.push($t(c,h,l,s)),a.push(...Ht(c,h,h===t.length-1,e,n,o,i))}),a}function Gt(t,e){e[Ot].rootNodes.forEach(e=>{Mt(e)?Gt(t,e):t.appendChild(e)})}function Bt(t,e,n){t.isFirst!==(0===e)&&(t.isFirst=0===e),t.isLast!==(e===n.length-1)&&(t.isLast=e===n.length-1),t.index!==e&&(t.index=e),t.each!==n[e]&&(t.each=n[e])}function Wt(t){return r(t)&&"length"!==t&&/^\d+$/.test(t)?Number(t):t}function Zt(t){const e=document.createElement("div");e.innerHTML=t||"";let n=e.childNodes;return n=0===n.length?[document.createComment("empty")]:[].slice.call(n),n}function qt(t,e,n){const r=new Lt(xt({[Ot]:{context:e,slots:{default:t}}}));return n&&r.__addStylePid(n),r[V].proxy}function Yt(e){const n=e._currentValue,r=e[Ot].slots;if(e.transition&&r){e._transitionMap=new Map;for(const s in r)e._transitionMap.set(s,[s===n?t.TransitionStates.ENTERED:t.TransitionStates.LEAVED,null]);e._previousValue=n,e._onEndHandler=e.onTransitionEnd.bind(e)}const s=r?r[n]:null,o=e[Ot].rootNodes;if(!s)return o.push(document.createComment("empty")),o;const i=qt(s,e[Ot].context,e[Ot].compStylePid);return o.push(i),i.__render()}function zt(t){var e;const n=t[Ot].rootNodes,r=n[0],s=Mt(r),o=s?r.__firstDOM:r,i=(s?o:r).parentNode,a=null===(e=t[Ot].slots)||void 0===e?void 0:e[t._currentValue];if(a){const e=qt(a,t[Ot].context,t[Ot].compStylePid),r=It(e.__render());i.insertBefore(r.length>1?v(r):r[0],o),n[0]=e}else n[0]=document.createComment("empty"),i.insertBefore(n[0],o);s?r.__destroy():i.removeChild(o),a&&n[0].__handleAfterRender(),t.__notify("branch-switched",t._branch)}function Jt(t,e,n,r){const s=t[1];if(s.nodeType!==Node.ELEMENT_NODE)return;const o=r._onEndHandler;s.classList.remove(e+(n?"-enter":"-leave")),s.classList.remove(e+(n?"-enter-active":"-leave-active")),L(s,"transitionend",o),L(s,"animationend",o),r.__notify("transition",n?"enter-cancelled":"leave-cancelled",s)}function Kt(e,n,r,s){const o=e[1],i=s._onEndHandler;if(o.nodeType!==Node.ELEMENT_NODE)return void i();const a=n+(r?"-enter":"-leave"),l=n+(r?"-enter-active":"-leave-active");o.classList.add(a),Vt(o),o.classList.add(l);const c=Vt(o);c?(e[0]=r?t.TransitionStates.ENTERING:t.TransitionStates.LEAVING,I(o,c,i),s.__notify("transition",r?"before-enter":"before-leave",o),N(()=>{s.__notify("transition",r?"enter":"leave",o)})):i()}function Qt(e){(Mt(e[Ot].rootNodes[0])||e[Ot].slots&&e[Ot].slots[e._currentValue])&&(e._transitionMap?function(e){const n=e._currentValue,r=e._previousValue,s=e.transition;let o=e._transitionMap.get(r);if(o||(o=["else"===r?t.TransitionStates.LEAVED:t.TransitionStates.ENTERED,null],e._transitionMap.set(r,o)),o[0]===t.TransitionStates.ENTERING){if(n===r)return;Jt(o,s,!0,e),Kt(o,s,!1,e)}else if(o[0]===t.TransitionStates.LEAVING){if(n!==r)return;Jt(o,s,!1,e),Kt(o,s,!0,e)}else o[0]===t.TransitionStates.ENTERED?(o[1]=e.__transitionDOM,Kt(o,s,!1,e)):o[0]===t.TransitionStates.LEAVED&&(o[1]=e.__transitionDOM,Kt(o,s,!0,e))}(e):zt(e))}function Xt(e){const n=e._currentValue,r=e._previousValue,s=e.transition,o=e._transitionMap.get(r),i=o[0]===t.TransitionStates.ENTERING,a=o[1];if(a.nodeType===Node.ELEMENT_NODE&&(L(a,"transitionend",e._onEndHandler),L(a,"animationend",e._onEndHandler),a.classList.remove(s+(i?"-enter":"-leave")),a.classList.remove(s+(i?"-enter-active":"-leave-active")),e.__notify("transition",i?"after-enter":"after-leave")),o[0]=i?t.TransitionStates.ENTERED:t.TransitionStates.LEAVED,i)return;zt(e),e._previousValue=n;const l=e._transitionMap.get(n);if(!l)return;const c=e.__transitionDOM;c.nodeType===Node.ELEMENT_NODE?(l[1]=c,Kt(l,s,!0,e)):l[0]=t.TransitionStates.ENTERED}function te(t){t._transitionMap&&(t._transitionMap.forEach(e=>{const n=e[1];n&&(L(n,"transitionend",t._onEndHandler),L(n,"animationend",t._onEndHandler))}),t._transitionMap=null)}function ee(t){const e=t._r._component,n=t[Ot].passedAttrs,r=xt({[Ot]:{context:t[Ot].context}});for(const t in n)r[t]=n[t];t._currentAttrs=r;const s=new e(r),o=t[Ot].compStylePid;return o&&s.__addStylePid(o),s[V].proxy}t.$$=V,t.ArrayProxyHandler=pt,t.BindHtmlComponent=class extends Lt{constructor(t){if(!("content"in t))throw new Error('<bind-html/> require "content" attribute');super(t),this.content=t.content}get content(){return this._c}set content(t){this._c!==t&&(this._c=t,this.__updateIfNeed())}__render(){return this[Ot].rootNodes=Zt(this._c)}__update(){const t=this[Ot].rootNodes,e=t[0],n=e.parentNode,r=Zt(this._c);n.insertBefore(r.length>1?v(r):r[0],e),t.forEach(t=>n.removeChild(t)),this[Ot].rootNodes=r}},t.Component=Lt,t.DynamicRenderComponent=class extends Lt{constructor(t){if(!n(t.render)||!Mt(t.render._component))throw new Error('<dynamic> component require "render" attribute to be object with "_component" property.');super(t),this._currentAttrs=null,this.render=t.render,t[V].__watch("*",t=>{this._currentAttrs[t[0]]=this[Ot].passedAttrs[t[0]]})}get render(){return this._r}set render(t){this._r!==t&&this._r._component!==t._component&&this.__updateIfNeed()}__render(){return ee(this).__render()}__update(){const t=this[Ot].rootNodes,e=t[0],n=e.__firstDOM,r=n.parentNode,s=ee(this);t[0]=s;const o=s.__render();r.insertBefore(o.length>1?v(o):o[0],n),e.__destroy(),s.__handleAfterRender()}},t.ForComponent=class extends Lt{constructor(e){if(e.key&&!/^(index|each(.[\w\d$_]+)*)$/.test(e.key))throw new Error('Value of "key" attribute of <for> component is invalidate. See https://[todo]');super(e),k(e.loop)?this.loop=e.loop:this._l=e.loop,e[V].__watch("loop",()=>{this.loop=e.loop});const n=e.key||"index";if(this._keyName=n,this._length=0,this._keys=null,this._waitingUpdate=!1,"index"!==n&&"each"!==n){this._keyName=new Function("each","return "+n);const t=n.split(".").length+1;this[V].__watch("loop.*."+n.slice(5),e=>{if(e.length!==t||this._waitingUpdate)return;const n=this.loop;if(!i(n)||0===n.length)return;const r=Wt(e[1]);!s(r)||r>=n.length||(this._keys[r]=this._keyName(n[r]))})}this[V].__watch("loop.*",e=>{if(this[Ot].state!==t.ComponentStates.RENDERED||2!==e.length||this._waitingUpdate)return;const n=Wt(e[1]);"length"===n?(this._waitingUpdate=!0,this.__updateIfNeed()):s(n)&&this._updateItem(n)})}get loop(){return this._l}set loop(t){this._l=t,this._waitingUpdate=!0,this.__updateIfNeed()}__render(){var t;const e=this[Ot].rootNodes,n=null===(t=this[Ot].slots)||void 0===t?void 0:t.default;if(!n)return e.push(document.createComment("empty")),e;const r=this.loop,s=this._keyName;return"index"!==s&&(this._keys=[]),i(r)&&0!==r.length?(this._length=r.length,Ft(r,n,e,this._keys,s,this[Ot].context,this[Ot].compStylePid)):(e.push(document.createComment("empty")),e)}_updateItem(t){var e;const n=this.loop,r=this[Ot].rootNodes;if(!i(n)||t>=r.length)return;const s=this._keys,o=n[t],a=r[t];if(a.each===o)return;const l=null===(e=this[Ot].slots)||void 0===e?void 0:e.default;if(!l)return;const c=this._keyName;if("index"!==c){const e="each"===c?o:c(o);if(e!==s[t]){const n=a.__firstDOM,i=jt(o,t,a.isLast,l,this[Ot].context,this[Ot].compStylePid),c=It(i.__render());n.parentNode.insertBefore(c.length>1?v(c):c[0],n),a.__destroy(),r[t]=i,s[t]=e,i.__handleAfterRender()}else a.each=o}else a.each=o}__update(){var t;this._waitingUpdate=!1;const e=null===(t=this[Ot].slots)||void 0===t?void 0:t.default;if(!e)return;const n=i(this.loop)?this.loop:[],r=this[Ot].rootNodes,s=n.length,o=this._length;if(0===s&&0===o)return;const a=this._keyName;if(0===s&&o>0){const t=r[0].__firstDOM,e=document.createComment("empty");t.parentNode.insertBefore(e,t);for(let t=0;t<o;t++)r[t].__destroy();return r.length=1,r[0]=e,"index"!==a&&(this._keys.length=0),void(this._length=0)}this._length=s;const l=this[Ot].context,c=this[Ot].compStylePid,h=r[0],_=(0===o?h:h.__firstDOM).parentNode;if("index"===a){let t=null;0===o&&(r.length=0);for(let i=0;i<s;i++)i<o?Bt(r[i],i,n):(t||(t=v()),Ht(n[i],i,i===s-1,e,r,l,c).forEach(e=>{t.appendChild(e)}));if(t){const e=0===o?h:r[o-1].__lastDOM;M(_,t,e);for(let t=o;t<s;t++)r[t].__handleAfterRender()}if(0===o&&_.removeChild(h),s>=o)return;for(let t=s;t<o;t++)r[t].__destroy();return void r.splice(s)}const d=this._keys;if(0===o){return r.length=0,M(_,v(Ft(n,e,r,d,a,this[Ot].context,this[Ot].compStylePid)),h),_.removeChild(h),void r.forEach(t=>t.__handleAfterRender())}const u=new Map;d.forEach((t,e)=>{u.set(t,e)});const f=[],p=new Map;n.forEach((t,e)=>{f.push($t(t,e,p,a))});let m=0,E=0,g=null;const y=[],N=new Uint8Array(o);for(;m<o||E<s;){for(;m<o;)if(0!==N[m])m++;else{if(p.has(d[m])&&p.get(d[m])>=E){m===o-1&&(g=r[m].__lastDOM.nextSibling);break}m===o-1&&(g=r[m].__lastDOM.nextSibling),r[m].__destroy(),m++}if(m>=o){let t=null;const r=y.length;for(;E<s;E++){const r=jt(n[E],E,E===s-1,e,l,c);t||(t=v()),r.__render().forEach(e=>t.appendChild(e)),y.push(r)}if(t){g?_.insertBefore(t,g):_.appendChild(t);for(let t=r;t<y.length;t++)y[t].__handleAfterRender()}break}const t=d[m];let i=null,a=null;for(;E<s;){const o=f[E];if(o===t)break;let h=null;if(u.has(o)){const t=u.get(o);t>m&&0===N[t]&&(h=r[t],N[t]=1)}i||(i=v()),h?(Gt(i,h),Bt(h,E,n)):(h=jt(n[E],E,E===s-1,e,l,c),h.__render().forEach(t=>i.appendChild(t)),a||(a=[]),a.push(h)),y.push(h),E++}if(E>=s)throw new Error("unimpossible?!");const h=r[m];i&&_.insertBefore(i,h.__firstDOM),a&&a.forEach(t=>t.__handleAfterRender()),Bt(h,E,n),y.push(h),m++,E++}this[Ot].rootNodes=y,this._keys=f}},t.ForEachComponent=Ut,t.HideComponent=class extends kt{constructor(t){t.class=wt({"jg-hide":t.test}),t[V].__watch("test",()=>{t.class["jg-hide"]!==t.test&&(t.class["jg-hide"]=t.test)}),super(t)}},t.I18nComponent=class extends Lt{constructor(t,e,n){super(t),this._key=e,this._vms=n,this.__i18nWatch(this._onchange)}__render(){return bt.__r(this._key,"components")(this,...this._vms)}_onchange(){this.__updateIfNeed()}__update(){this[V].__related&&(this[V].__related.forEach((t,e)=>{t.forEach(t=>{e.__unwatch(t.prop,t.handler)})}),this[V].__related.clear());let t=this.__lastDOM;const e=t.parentNode;t=t.nextSibling,this.__handleBeforeDestroy(!0);const n=this.__render();t?e.insertBefore(n.length>1?v(n):n[0],t):e.appendChild(n.length>1?v(n):n[0]),this[Ot].rootNodes.forEach(t=>{Mt(t)&&t.__handleAfterRender()}),this[Ot].nonRootCompNodes.forEach(t=>{t.__handleAfterRender()})}__beforeDestroy(){this._vms=null}},t.IfComponent=class extends Lt{constructor(t){super(t),this._currentValue="default",this._onEndHandler=null,this._transitionMap=null,this._previousValue=null,this.expect=t.expect,this.transition=t.transition}get expect(){return"default"===this._currentValue}set expect(t){const e=t?"default":"else";this._currentValue!==e&&(this._currentValue=e,this.__updateIfNeed())}get _branch(){return this.expect}onTransitionEnd(){Xt(this)}__render(){return Yt(this)}__update(){Qt(this)}__beforeDestroy(){te(this)}},t.LogComponent=class extends Lt{constructor(t){super(t),this.msg=t.msg}set msg(t){console.log(t),this._msg=t}get msg(){return this._msg}__render(){return[document.createComment("log placeholder")]}},t.MESSENGER_LISTENERS=vt,t.Messenger=Dt,t.ParameterComponent=class extends Lt{constructor(t,e){super(t),e.forEach(e=>{this[e]=t[e],t[V].__watch(e,()=>{this[e]=t[e]})})}},t.SwitchComponent=class extends Lt{constructor(t){super(t),this._onEndHandler=null,this._transitionMap=null,this._previousValue=null,this._currentValue=null,this.test=t.test,this.transition=t.transition}get test(){return this._currentValue}set test(t){const e=this[Ot].slots;e&&t in e||(t="default"),this._currentValue!==t&&(this._currentValue=t,this.__updateIfNeed())}get _branch(){return this.test}onTransitionEnd(){Xt(this)}__render(){return Yt(this)}__update(){Qt(this)}__beforeDestroy(){te(this)}},t.ToggleClassComponent=kt,t.ViewModelCoreImpl=X,t.__=Ot,t._t=function(t,e){return e?St(t)(e):t},t.addEvent=I,t.addParent=$,t.appendChildren=D,t.arrayEqual=h,t.arrayPushIfNotExist=function(t,e){t.indexOf(e)>=0||t.push(e)},t.arrayRemove=c,t.assertRenderResults=It,t.attrs=xt,t.bootstrap=function(t,e,n){t.create(n).__renderToDOM(e,e!==document.body)},t.clearImmediate=w,t.compile=St,t.createAttributes=yt,t.createComponent=Nt,t.createElement=R,t.createElementWithChild=function(t,e,n){const r=R(t,e);return r.appendChild(n),r},t.createElementWithoutAttrs=function(t,...e){return R(t,null,...e)},t.createFragment=v,t.createSVGElement=O,t.createSVGElementWithoutAttrs=function(t,...e){return O(t,null,...e)},t.createTextNode=x,t.createViewModel=gt,t.deleteNode=K,t.emptyRenderFn=function(t){const e=document.createComment("empty");return t[Ot].rootNodes.push(e),e},t.errorRenderFn=function(t){const e=R("span",{style:"color: red !important;"});return e.textContent="template parsing failed! please check webpack log.",t[Ot].rootNodes.push(e),e},t.getDuration=function(t){const e=getComputedStyle(t);let n=e.getPropertyValue("transition-duration");return"0s"!==n?{type:"transitionend",time:Pt(n)}:(n=e.getPropertyValue("animation-duration"),"0s"!==n?{type:"animationend",time:Pt(n)}:{type:null,time:0})},t.getDurationType=Vt,t.getPropertyName=j,t.handleCancel=W,t.handleOnce=Z,t.i18n=bt,t.i18nRenderFn=function(t,e,n=!1){const r=x(),s=()=>{r.textContent=bt.__t(e)};return s(),t.__i18nWatch(s),n&&t[Ot].rootNodes.push(r),r},t.insertAfter=M,t.isArray=i,t.isBoolean=function(t){return"boolean"==typeof t||t instanceof Boolean},t.isComponent=Mt,t.isFunction=a,t.isInnerObj=P,t.isNumber=s,t.isObject=n,t.isPromise=l,t.isPublicProperty=U,t.isString=r,t.isUndefined=o,t.isViewModel=k,t.loopClearNode=Q,t.loopCreateNode=z,t.loopGetNode=J,t.loopHandle=q,t.loopNotify=Y,t.manager=Ct,t.parsePropertyPath=H,t.registerEvent=A,t.removeAttribute=S,t.removeEvent=L,t.removeParent=F,t.replaceChildren=C,t.setAttribute=b,t.setImmediate=N,t.setText=function(t,e){r(e)||(e=JSON.stringify(e)),t.textContent=e},t.shiftParent=G,t.textRenderFn=function(t,e){const n=x(e);return t[Ot].rootNodes.push(n),n},t.typeOf=e,t.uid=d,t.unwatch=function(t,e,n){t[V].__unwatch(e,n)},t.vm=wt,t.watch=function(t,e,n){t[V].__watch(e,n)},Object.defineProperty(t,"__esModule",{value:!0})}));
